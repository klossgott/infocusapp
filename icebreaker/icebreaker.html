document.addEventListener('DOMContentLoaded', function() {
    const prompts = [
        "What's the weirdest movie you've ever seen?",
        "Is there a pizza topping that most people hate but you secretly love?",
        "Window seat or aisle seat?",
        // ... rest of your prompts ...
    ];

    const widgetImage = document.getElementById('widget-image');
    const icebreakerCard = document.getElementById('icebreaker-card');
    const icebreakerText = document.getElementById('icebreaker-text');
    const iceSound = document.getElementById('ice-sound');
    const coverOverlay = document.getElementById('cover-overlay');

    let isExpanded = false;
    let lastClickTime = 0;
    const doubleClickDelay = 300; // milliseconds

    // Handle clicks on cover overlay
    coverOverlay.addEventListener('click', (e) => {
        const currentTime = new Date().getTime();
        const timeDiff = currentTime - lastClickTime;

        if (timeDiff < doubleClickDelay && isExpanded) {
            // Double click detected while expanded - return to resting state
            coverOverlay.classList.remove('expanded');
            coverOverlay.classList.add('resting');
            isExpanded = false;
        } else if (isExpanded) {
            // Single click while expanded - start the game
            startGame();
        } else {
            // Single click while resting - expand
            coverOverlay.classList.remove('resting');
            coverOverlay.classList.add('expanded');
            isExpanded = true;
        }

        lastClickTime = currentTime;
    });

    function startGame() {
        coverOverlay.style.animation = 'coverFadeOutFlip 0.5s forwards';
        coverOverlay.addEventListener('animationend', () => {
            coverOverlay.style.display = 'none';
            widgetImage.style.display = 'block';
            widgetImage.src = 'ice-cubes.png';
        }, { once: true });
    }

    // Handle widget image click
    widgetImage.addEventListener('click', () => {
        playRandomIceSound();
        widgetImage.src = 'broken-ice.png';
        widgetImage.classList.add('explode');
        widgetImage.addEventListener('animationend', onExplodeAnimationEnd, { once: true });
    });

    function onExplodeAnimationEnd() {
        widgetImage.style.display = 'none';
        widgetImage.classList.remove('explode');
        widgetImage.style.transform = 'translate(-50%, -50%)';
        widgetImage.style.width = '50%';
        showIcebreaker();
    }

    function showIcebreaker() {
        icebreakerText.textContent = getRandomPrompt();
        const baseColor = '#F8F0E3';
        const hsl = hexToHsl(baseColor);
        const lightnessAdjustment = (Math.random() * 20) - 10;
        const newL = Math.min(100, Math.max(0, hsl.l + lightnessAdjustment));
        const newColor = hslToHex(hsl.h, hsl.s, newL);
        icebreakerCard.style.backgroundColor = newColor;
        icebreakerCard.style.display = 'flex';
        icebreakerCard.style.animationName = 'fadeInFlip';
    }

    // Reset to initial state when card is clicked
    icebreakerCard.addEventListener('click', () => {
        icebreakerCard.style.animationName = 'fadeOutFlip';
        icebreakerCard.addEventListener('animationend', () => {
            icebreakerCard.style.display = 'none';
            coverOverlay.style.display = 'flex';
            coverOverlay.style.animation = '';
            coverOverlay.classList.remove('expanded');
            coverOverlay.classList.add('resting');
            isExpanded = false;
        }, { once: true });
    });

    function getRandomPrompt() {
        return prompts[Math.floor(Math.random() * prompts.length)];
    }

    function playRandomIceSound() {
        const duration = 0.5; // Duration in seconds
        
        if (iceSound.readyState >= 2) {
            // Calculate a random start time, ensuring we don't exceed the audio duration
            const totalDuration = iceSound.duration;
            const maxStartTime = Math.max(0, totalDuration - duration);
            const randomStartTime = Math.random() * maxStartTime;
            
            // Set the start time and play
            iceSound.currentTime = randomStartTime;
            iceSound.play();
            
            // Stop after the specified duration
            setTimeout(() => {
                iceSound.pause();
                iceSound.currentTime = 0;
            }, duration * 1000);
        } else {
            // If audio isn't loaded yet, wait for it
            iceSound.addEventListener('loadedmetadata', () => {
                playRandomIceSound();
            }, { once: true });
        }
    }

    // Keep your existing hexToHsl and hslToHex functions...
});
