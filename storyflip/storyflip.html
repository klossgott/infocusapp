<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Flip</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap">
    <style>
        :root {
            --color-primary: #FFA500;      /* Orange */
            --color-resting: #FFD700;      /* Gold for resting state */
            --color-title: #FFD700;        /* Gold */
            --color-instructions: #FFE4B5;  /* Moccasin */
            --color-story: #FFD700;        /* Gold */
            --color-number: #ADD8E6;       /* Light Blue */
            --color-rhythm: #FFB6C1;       /* Light Pink */
            --color-wildcard: #F5A9A9;     /* Light Pink-Orange */
            --color-driver: #D3D3D3;       /* Light Grey */
            --color-gamemaster: #98FB98;   /* Light Green */
            --font-base: 'EB Garamond', serif;
            --transition-base: 0.3s ease;
        }

        html, body {
            height: 100%;
            margin: 0;
            background: transparent;
            font-family: var(--font-base);
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            position: relative;
            width: min(40vw, 400px);
            height: calc(min(40vw, 400px) * 1.5);
            padding: 10px;
            box-sizing: border-box;
            transition: all var(--transition-base);
        }

        .container.resting {
            transform: scale(0.3);
        }

        .card {
            width: 100%;
            height: 100%;
            background-color: var(--color-primary);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
        }

        .card.resting {
            background-color: var(--color-resting);
        }

        .card-content {
            font-size: 3vh;
            color: #333;
            line-height: 1.5;
            transition: opacity var(--transition-base);
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            word-break: break-word;
            margin: 0 auto;
        }

        .card.resting .card-content {
            font-size: 14vh;
            font-weight: bold;
            color: var(--color-primary);
        }

        .card.instructions .card-content {
            font-style: italic;
        }

        .timer {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 5px;
            background-color: rgba(51, 51, 51, 0.5);
            transition: width 1s linear;
            width: 100%;
        }

        .placeholder {
            background-color: rgba(255, 255, 255, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .pause-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 3vh;
            border-radius: 10px;
            z-index: 10;
        }

        .card:focus {
            outline: none;
        }

        .flash {
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0%, 100% { background-color: var(--color-story); }
            50% { background-color: var(--color-title); }
        }

        @media (max-width: 600px) {
            .container {
                width: 90vw;
                height: calc(90vw * 1.5);
                padding: 5px;
            }

            .card-content {
                font-size: 4vh;
            }

            .card.resting .card-content {
                font-size: 16vh;
            }

            .pause-overlay {
                font-size: 4vh;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="game-container">
        <div class="card resting" id="game-card" role="button" tabindex="0" aria-label="Story Flip Card">
            <div class="card-content" id="card-content">S</div>
            <div class="timer" id="timer-bar"></div>
            <div class="pause-overlay" id="pause-overlay">Game Paused. Press Spacebar to resume.</div>
        </div>
    </div>

    <script>
        class StoryFlipGame {
            constructor() {
                this.initializeElements();
                this.initializeState();
                this.loadGameData();
                this.setupEventListeners();
            }

            initializeElements() {
                this.container = document.getElementById('game-container');
                this.card = document.getElementById('game-card');
                this.content = document.getElementById('card-content');
                this.timerBar = document.getElementById('timer-bar');
                this.pauseOverlay = document.getElementById('pause-overlay');
            }

            initializeState() {
                this.state = {
                    cardState: 'resting',
                    isPaused: false,
                    instructionIndex: 0,
                    turnCount: 0,
                    tryAgainCount: 0,
                    lastCategories: [],
                    timerInterval: null,
                    storyRhythmTurn: Math.floor(Math.random() * 5) + 8, // Random turn between 8-12
                    storyRhythmUsed: false
                };
            }

            loadGameData() {
                // Your existing gameData object here, with the addition of Game Master category
                this.gameData = {
                    instructions: [
                        [
                            "Welcome, Storytellers",
                            "Set a timer for how long you want to play.",
                            "Listen carefully, pick up on developments, and keep the story going.",
                            "What happens next? Take turns to tell each other, or type in the chat. You have 20 seconds."
                        ],
                        [
                            "Press:",
                            "'W' for a Wildcard, if you're stuck.",
                            "'Space Bar' to Pause-and-tell.",
                            "'N' for a new game, 'X' to exit.",
                            "Click the card to flip, get inspired, and start telling!"
                        ]
                    ],
                    // ... rest of your existing gameData ...
                };

                // Initialize used prompts tracking
                this.usedPrompts = {
                    storyElements: {
                        setting: [],
                        character: [],
                        action: [],
                        emotion: [],
                        object: [],
                        dialogue: [],
                        conflict: [],
                        resolution: []
                    },
                    wildcard: [],
                    numberCard: [],
                    storyRhythm: [],
                    openStoryDriver: [],
                    gameMaster: []
                };
            }

            // Updated methods to fix identified issues

            expandCard() {
                this.container.classList.remove('resting');
                this.card.classList.remove('resting');
                this.card.classList.add('active');
                this.content.style.fontSize = '';
                this.content.style.color = '#333';
            }

            minimizeCard() {
                this.container.classList.add('resting');
                this.card.classList.add('resting');
                this.state.cardState = 'resting';
                this.content.innerHTML = 'S';
                this.content.style.color = 'var(--color-primary)';
                this.clearGameState();
            }

            clearGameState() {
                this.timerBar.style.width = '0%';
                this.timerBar.style.display = 'none';
                clearInterval(this.state.timerInterval);
                this.state.tryAgainCount = 0;
                this.state.turnCount = 0;
                this.state.lastCategories = [];
                this.state.instructionIndex = 0;
                this.state.storyRhythmUsed = false;
                this.state.storyRhythmTurn = Math.floor(Math.random() * 5) + 8;
                if (this.state.isPaused) this.togglePause();
            }

            // Updated showInstructions method for better formatting
            showInstructions() {
                this.state.cardState = 'instructions';
                this.card.classList.add('instructions');
                this.displayInstructions();
                this.setCardColor('instructions');
            }

            // Updated handleTimerEnd method with correct styling
            handleTimerEnd() {
                this.state.tryAgainCount++;
                const message = this.state.tryAgainCount > 1 
                    ? "Time's up!<br>Take a deep breath and try again.<br>Try pressing 'W' for Wildcards!"
                    : "Time's up!<br>Take a deep breath and try again.";
                
                this.content.innerHTML = `<i>${message}</i>`;
                this.setCardColor('instructions');
                this.state.cardState = 'active';
                this.state.lastCategories = [];
            }

            // Updated getRandomCardType method to handle Story Rhythm frequency
            getRandomCardType() {
                if (this.state.turnCount === this.state.storyRhythmTurn && !this.state.storyRhythmUsed) {
                    this.state.storyRhythmUsed = true;
                    return 'storyRhythm';
                }

                const types = ['storyElements', 'wildcard', 'numberCard', 'gameMaster'];
                let selectedType;
                let attempts = 0;
                do {
                    selectedType = types[Math.floor(Math.random() * types.length)];
                    attempts++;
                    const occurrence = this.state.lastCategories.filter(cat => cat === selectedType).length;
                    if (occurrence < 2) break;
                } while (attempts < 10);
                return selectedType;
            }

            // Rest of your existing methods...
        }

        // Initialize game when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new StoryFlipGame();
        });
    </script>
</body>
</html>
