<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Story Flip</title>
    <!-- Include Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;700&display=swap">
    <style>
        /* Inline CSS */
        html, body {
            height: 100%;
            margin: 0;
        }
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
        }
        #widget-container {
            position: relative;
            width: 340px;
            height: 500px;
            background: transparent;
            overflow: visible;
        }
        #widget-card {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background-color: #fff;
            border-radius: 10px;
            transform: translate(-50%, -50%) scale(0.15);
            box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.5s ease, background-color 0.5s ease;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #widget-card.active {
            transform: translate(-50%, -50%) scale(1);
        }
        #card-text {
            font-family: 'EB Garamond', serif;
            font-size: 1.4em;
            color: #333;
            line-height: 1.5;
            font-weight: 400;
            letter-spacing: 0.05em;
            margin: 20px;
            word-wrap: break-word;
            white-space: normal;
        }
        .typing-animation {
            display: inline-block;
            overflow: hidden;
            white-space: normal;
            animation: typing 2s steps(40, end);
            border-right: 2px solid black;
        }
        #timer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 5px;
            background-color: rgba(51, 51, 51, 0.5);
            transition: width 1s linear;
            display: none;
        }
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
    </style>
</head>
<body>

<div id="widget-container">
    <!-- Card Front -->
    <div id="widget-card" class="resting">
        <div id="card-text"></div>
        <div id="timer-bar"></div> <!-- Timer bar element -->
    </div>
</div>

<script>
    // Inline JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        const prompts = {
            "title": "<b style='font-size: 2em; font-variant: small-caps;'>Story Flip</b>",
            "instructions": [
                "Welcome to <b>Story Flip</b>!",
                "Take turns to tell each other or type in the chat what happens next. You have 20 seconds.",
                "Click the card to flip and receive story instructions.",
                "If you're stuck, press 'W' for a Wildcard.",
                "Press 'N' for a new game, 'X' to exit."
            ],
            "gameMaster": [
                "<b><i>Add a sentence that expands on what has happened so far.</i></b>",
                "<b><i>What happened next?</i></b>",
                "<b><i>And then?</i></b>",
                "<b><i>A new character enters the story.</i></b>",
                "<i>Suddenly...</i>",
                "Describe the weather in this scene.",
                "<b><i>Add a dramatic moment!</i></b>"
            ],
            "numberCard": [
                "Change everything in just [x] word[s].",
                "Continue the sentence adding [x] word[s].",
                "Expand the scene adding [x] word[s].",
                "Tell us about what [Name] is doing.",
                "Start a new challenge using [x] word[s].",
                "[Name] feels [x] word[s]."
            ],
            "wildcard": [
                "<i>Then, something unexpected happened...</i>",
                "At this moment, the character felt <b><i>[emotion]</i></b>...",
                "<i>Suddenly, a new element joined the scene.</i>",
                "What happens if something goes wrong?",
                "Describe a noise they heard nearby."
            ]
        };

        const usedPrompts = {
            "gameMaster": [],
            "wildcard": []
        };

        const card = document.getElementById("widget-card");
        const cardTextElement = document.getElementById("card-text");
        const timerBarElement = document.getElementById("timer-bar");

        let cardState = 'resting'; // resting, title, instructions, active
        let timerInterval;

        // Initial minimized state
        card.classList.add('resting');
        cardState = 'resting';

        // Handle card clicks
        card.addEventListener('click', (event) => {
            event.stopPropagation();
            if (cardState === 'resting') {
                expandCard();
                showTitlePage();
            } else if (cardState === 'title') {
                showInstructions();
            } else if (cardState === 'instructions') {
                startGame();
            } else if (cardState === 'active') {
                flipCard();
            }
        });

        // Remove popup, handle clicks outside the card within the card itself
        document.addEventListener('click', (e) => {
            if (!card.contains(e.target)) {
                showExitOptions();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'x') {
                minimizeCard();
            }
            if (e.key.toLowerCase() === 'n') {
                window.location.reload();
            }
            if (e.key.toLowerCase() === 'w' && cardState === 'active') {
                showWildcardPrompt();
            }
        });

        function showExitOptions() {
            cardTextElement.innerHTML = "<b>Press 'X' to minimize the card or click to continue playing.</b>";
            cardState = 'exitOptions';
        }

        function minimizeCard() {
            cardState = 'resting';
            card.classList.remove('active');
            card.classList.add('resting');
            cardTextElement.innerHTML = ''; // Clear any text
            timerBarElement.style.width = '0%'; // Clear timer bar
            timerBarElement.style.display = 'none'; // Hide timer bar
            clearInterval(timerInterval); // Clear any running timer
        }

        function expandCard() {
            card.classList.remove('resting');
            card.classList.add('active');
        }

        function showTitlePage() {
            cardState = 'title';
            cardTextElement.innerHTML = prompts.title;
            setCardColor('#FFD700'); // Golden color for title page
        }

        function showInstructions() {
            cardState = 'instructions';
            cardTextElement.innerHTML = prompts.instructions.join("<br><br>");
            setCardColor('#FFE4B5'); // Light warm color
        }

        function startGame() {
            cardState = 'active';
            flipCard();
        }

        function flipCard() {
            // Hide card content briefly to simulate flip
            cardTextElement.style.opacity = '0';
            setTimeout(() => {
                const cardType = getRandomCardType();
                if (cardType === 'gameMaster') {
                    showGameMasterPrompt();
                } else if (cardType === 'numberCard') {
                    showNumberCardPrompt();
                }
                // Start the timer after showing the prompt
                startTimer();
                cardTextElement.style.opacity = '1';
            }, 300);
        }

        function getRandomCardType() {
            const types = ['gameMaster', 'numberCard'];
            return types[Math.floor(Math.random() * types.length)];
        }

        function showGameMasterPrompt() {
            const prompt = getUniquePrompt('gameMaster');
            if (!prompt) {
                cardTextElement.innerHTML = "<b>No more prompts available. Press 'N' for a new game.</b>";
                clearInterval(timerInterval);
                timerBarElement.style.display = 'none';
                return;
            }
            setCardColor('#FFA500'); // Warm yellow-orange color
            showTypingAnimation(prompt);
        }

        function showNumberCardPrompt() {
            let prompt = getRandomPrompt('numberCard');
            const num = getRandomNumber(1, 6);
            let plural = num === 1 ? '' : 's';
            prompt = prompt.replace('[x]', num).replace('[s]', plural);
            prompt = prompt.replace('[Name]', 'the character');
            setCardColor('#ADD8E6'); // Light blue color for number cards
            cardTextElement.innerHTML = prompt;
        }

        function showWildcardPrompt() {
            const prompt = getUniquePrompt('wildcard');
            if (!prompt) {
                cardTextElement.innerHTML = "<b>No more wildcards available.</b>";
                return;
            }
            setCardColor('#F5A9A9'); // Desaturated pink-orange color
            showTypingAnimation(prompt);
        }

        function getRandomPrompt(category) {
            const categoryPrompts = prompts[category];
            return categoryPrompts[Math.floor(Math.random() * categoryPrompts.length)];
        }

        function getUniquePrompt(category) {
            const availablePrompts = prompts[category].filter(p => !usedPrompts[category].includes(p));
            if (availablePrompts.length === 0) {
                return null;
            }
            const prompt = availablePrompts[Math.floor(Math.random() * availablePrompts.length)];
            usedPrompts[category].push(prompt);
            return prompt;
        }

        function setCardColor(color) {
            card.style.backgroundColor = color;
        }

        function showTypingAnimation(text) {
            cardTextElement.innerHTML = `<span class="typing-animation">${text}</span>`;
        }

        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function startTimer() {
            let timeLeft = 20; // 20-second timer
            let timerWidth = 100;

            clearInterval(timerInterval); // Clear any previous timer
            timerBarElement.style.width = timerWidth + '%';
            timerBarElement.style.display = 'block';

            timerInterval = setInterval(() => {
                timeLeft--;
                timerWidth -= 5; // Reduce width over 20 seconds
                timerBarElement.style.width = timerWidth + '%';

                if (timeLeft <= 3) {
                    // Flash white towards the end
                    card.style.backgroundColor = timeLeft % 2 === 0 ? 'white' : card.style.backgroundColor;
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerBarElement.style.width = '0%';
                    timerBarElement.style.display = 'none';
                    handleTimerEnd();
                }
            }, 1000);
        }

        function handleTimerEnd() {
            setCardColor('#777777'); // Medium grey
            cardTextElement.innerHTML = "<b style='color: white;'>Time's up!<br>Take a deep breath and try again.</b>";
            // Hide timer bar
            timerBarElement.style.display = 'none';
            // Keep the game in the 'active' state to allow the player to continue
            cardState = 'active';
        }
    });
</script>

</body>
</html>
