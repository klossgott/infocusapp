<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Story Flip</title>
    <!-- Include Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;700&display=swap">
    <style>
        /* Inline CSS */
        html, body {
            height: 100%;
            margin: 0;
            background: transparent; /* Transparent background */
        }
        body {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #widget-container {
            position: relative;
            width: 340px;
            height: 500px;
            background: transparent;
            overflow: hidden; /* Prevent overflow */
        }
        #widget-card {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background-color: #FFD700; /* Yellow for resting state */
            border-radius: 10px;
            transform: translate(-50%, -50%) scale(0.15);
            box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.5s ease, background-color 0.5s ease;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px; /* Padding to prevent text from touching borders */
            box-sizing: border-box;
        }
        #widget-card.active {
            transform: translate(-50%, -50%) scale(1);
        }
        #card-text {
            font-family: 'EB Garamond', serif;
            font-size: 1.4em;
            color: #333;
            line-height: 1.5;
            font-weight: 400;
            letter-spacing: 0.05em;
            word-wrap: break-word;
            white-space: normal;
        }
        /* Resting state styling with large 'S' */
        #widget-card.resting #card-text {
            font-size: 3em;
            font-weight: bold;
            color: #FFA500; /* Bright orange 'S' */
            margin: 0; /* Remove margin to center 'S' */
        }
        .typing-animation {
            display: inline-block;
            overflow: hidden;
            white-space: pre-wrap; /* Allow wrapping */
            word-wrap: break-word;
            animation: typing 2s steps(40, end) forwards;
        }
        #timer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 5px;
            background-color: rgba(51, 51, 51, 0.5);
            transition: width 1s linear;
            display: none;
        }
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
    </style>
</head>
<body>

<div id="widget-container">
    <!-- Card Front -->
    <div id="widget-card" class="resting">
        <div id="card-text">S</div>
        <div id="timer-bar"></div> <!-- Timer bar element -->
    </div>
</div>

<script>
    // Inline JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        const prompts = {
            "title": "<b style='font-size: 2em; font-variant: small-caps;'>Story Flip</b>",
            "instructions": [
                "Welcome to <b>Story Flip</b>!",
                "Take turns to tell each other or type in the chat what happens next. You have 20 seconds.",
                "Click the card to flip and receive story instructions.",
                "If you're stuck, press 'W' for a Wildcard.",
                "Press 'N' for a new game, 'X' to exit."
            ],
            "gameMaster": [
                "<b><i>Add a sentence that expands on what has happened so far.</i></b>",
                "<b><i>What happened next?</i></b>",
                "<b><i>And then?</i></b>",
                "<b><i>A new character enters the story.</i></b>",
                "<i>Suddenly...</i>",
                "Describe the weather in this scene.",
                "<b><i>Add a dramatic moment!</i></b>",
                "What if...",
                "Meanwhile...",
                "Embrace an opposite.",
                "Pick a fight.",
                "Lose the best asset.",
                "Compare something to something. Use a metaphor.",
                "Invent a new word and use it.",
                "Make an unlikely comparison.",
                "Say something ridiculous.",
                "Say something wise.",
                "Say something crazy.",
                "Smell.",
                "See.",
                "Touch.",
                "Hear.",
                "Taste.",
                "Run.",
                "Walk.",
                "Crawl.",
                "Fly.",
                "Create an unlikely alliance."
            ],
            "numberCard": [
                "Change everything in just [x] word[s].",
                "Continue the sentence adding [x] word[s].",
                "Expand the scene adding [x] word[s].",
                "Tell us about what <u>NAME</u> is doing.",
                "Start a new challenge using [x] word[s].",
                "<u>NAME</u> feels [x] word[s]."
            ],
            "wildcard": [
                "<i>Then, something unexpected happened...</i>",
                "At this moment, <u>NAME</u> felt <u>EMOTION</u>...",
                "<i>Suddenly, a new element joined the scene.</i>",
                "What happens if something goes wrong?",
                "Describe a noise they heard nearby.",
                "Out of nowhere, something happened that no one could have predicted...",
                "A decision had to be made immediately, and the stakes were...",
                "Without warning, <u>NAME</u> was presented with an option that could..."
            ],
            // Additional categories and prompts
            "setting": [
                "It felt cold because <u>ACTION</u>.",
                "The place was unlike anything they'd seen before, with <u>DESCRIPTION</u>.",
                "The noise in the background was growing louder, and <u>ACTION</u>.",
                "The sky above was <u>DESCRIPTION</u>.",
                "They noticed something unusual in the surroundings: a <u>OBJECT</u>."
            ],
            "character": [
                "The person looked at <u>NAME</u> with eyes that seemed <u>DESCRIPTION</u>.",
                "This was <u>NAME</u> known for their ability to <u>ACTION</u>.",
                "No one could figure out why <u>NAME</u> was so protective of <u>OBJECT</u>.",
                "A stranger appeared, holding a <u>OBJECT</u>.",
                "<u>NAME</u> smiled, but it didn’t quite reach their eyes. It was because <u>EMOTION</u>."
            ],
            "action": [
                "Suddenly, <u>NAME</u> decided to <u>ACTION</u>.",
                "There was no time to waste, <u>NAME</u> had to <u>ACTION</u>.",
                "The next thing <u>NAME</u> did was <u>ACTION</u>.",
                "<u>NAME</u> took a deep breath and chose to <u>ACTION</u>.",
                "The group collectively decided that the only way forward was to <u>ACTION</u>."
            ],
            "emotion": [
                "A chill of fear ran through <u>NAME</u> as they thought about <u>ACTION</u>.",
                "A feeling of hope surged in <u>NAME</u> when they saw <u>DESCRIPTION</u>.",
                "Anger bubbled beneath the surface, triggered by <u>ACTION</u>.",
                "<u>NAME</u> couldn’t hide their excitement because <u>ACTION</u>.",
                "The tension in the air shifted when <u>NAME</u> felt a sudden wave of <u>EMOTION</u>."
            ],
            "object": [
                "<u>NAME</u> stumbled upon an object—it was <u>DESCRIPTION</u>.",
                "Something small but significant caught <u>NAME</u>'s eye—a <u>OBJECT</u>.",
                "<u>NAME</u> held a mysterious item that seemed to <u>ACTION</u>.",
                "The item was ordinary to most people, but to <u>NAME</u>, it meant <u>PURPOSE</u>.",
                "<u>NAME</u> carefully placed the object on the ground, knowing it would <u>ACTION</u>."
            ],
            "dialogue": [
                "<u>NAME</u> whispered, 'I think it's time we talk about <u>PURPOSE</u>.'",
                "'Are you sure we should be doing this?' <u>NAME</u> asked.",
                "'There’s something I need to tell you,' <u>NAME</u> said, with hesitation.",
                "'If you go now, there’s no coming back,' was the warning given by <u>NAME</u>.",
                "'I have a plan, but you’re not going to like it,' <u>NAME</u> stated plainly."
            ],
            "conflict": [
                "Something suddenly stood in <u>NAME</u>'s way—something that <u>ACTION</u>.",
                "<u>NAME</u> realized there was a critical piece missing that could <u>ACTION</u>.",
                "A disagreement broke out over <u>PURPOSE</u>.",
                "The group had to deal with a sudden change that threw everything into <u>CONFLICT</u>.",
                "<u>NAME</u> decided to break the rules, which led to <u>CONFLICT</u>."
            ],
            "resolution": [
                "After a long pause, <u>NAME</u> finally chose to <u>ACTION</u>.",
                "Things were resolved when <u>NAME</u> decided to <u>ACTION</u>.",
                "It wasn’t what <u>NAME</u> expected, but they accepted it and moved on because <u>PURPOSE</u>.",
                "<u>NAME</u> reached a quiet understanding that meant <u>RESOLUTION</u>.",
                "With a final effort, <u>NAME</u> managed to <u>ACTION</u>."
            ],
            "openStoryDriver": [
                "What's next?",
                "What now?",
                "And then?",
                "What if...",
                "Meanwhile...",
                "After that...",
                "Suddenly...",
                "Then...",
                "Further along, ...",
                "Thereafter, ...",
                "Again, ...",
                "Surprisingly, ...",
                "Wow!",
                "Incredible!",
                "Sadly, ...",
                "Unbelievable, but true, ...",
                "How strange!",
                "Yes, it was true.",
                "It was time.",
                "This was the place.",
                "That's how it had to be done.",
                "It had to happen that way.",
                "There was nothing else to do now.",
                "Yes!",
                "No!",
                "Maybe.",
                "Actually, ..."
            ]
        };

        const usedPrompts = {
            "gameMaster": [],
            "wildcard": [],
            "setting": [],
            "character": [],
            "action": [],
            "emotion": [],
            "object": [],
            "dialogue": [],
            "conflict": [],
            "resolution": []
        };

        const card = document.getElementById("widget-card");
        const cardTextElement = document.getElementById("card-text");
        const timerBarElement = document.getElementById("timer-bar");

        let cardState = 'resting'; // resting, title, instructions, active, exitOptions
        let timerInterval;
        let tryAgainCount = 0; // Counter for "Time's up! Try again"

        // Initial minimized state with 'S' on the card
        card.classList.add('resting');
        cardState = 'resting';

        // Handle card clicks
        card.addEventListener('click', (event) => {
            event.stopPropagation();
            if (cardState === 'resting') {
                expandCard();
                showTitlePage();
            } else if (cardState === 'title') {
                showInstructions();
            } else if (cardState === 'instructions') {
                startGame();
            } else if (cardState === 'active' || cardState === 'exitOptions') {
                flipCard();
            }
        });

        // Handle clicks outside the card
        document.addEventListener('click', (e) => {
            if (!card.contains(e.target)) {
                showExitOptions();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'x') {
                minimizeCard();
            }
            if (e.key.toLowerCase() === 'n') {
                window.location.reload();
            }
            if (e.key.toLowerCase() === 'w' && cardState === 'active') {
                showWildcardPrompt();
            }
        });

        function showExitOptions() {
            cardTextElement.innerHTML = "<b>Press 'X' to minimize the card or click to continue playing.</b>";
            cardState = 'exitOptions';
            clearInterval(timerInterval);
            timerBarElement.style.display = 'none';
        }

        function minimizeCard() {
            cardState = 'resting';
            card.classList.remove('active');
            card.classList.add('resting');
            cardTextElement.innerHTML = 'S'; // Display 'S' again
            cardTextElement.style.fontSize = '3em';
            timerBarElement.style.width = '0%'; // Clear timer bar
            timerBarElement.style.display = 'none'; // Hide timer bar
            clearInterval(timerInterval); // Clear any running timer
            tryAgainCount = 0; // Reset try again counter
        }

        function expandCard() {
            card.classList.remove('resting');
            card.classList.add('active');
            cardTextElement.style.fontSize = ''; // Reset font size
            cardTextElement.style.color = '#333'; // Reset text color
        }

        function showTitlePage() {
            cardState = 'title';
            cardTextElement.innerHTML = prompts.title;
            setCardColor('#FFD700'); // Golden color for title page
        }

        function showInstructions() {
            cardState = 'instructions';
            cardTextElement.innerHTML = prompts.instructions.join("<br><br>");
            setCardColor('#FFE4B5'); // Light warm color
        }

        function startGame() {
            cardState = 'active';
            flipCard();
        }

        function flipCard() {
            // Hide card content briefly to simulate flip
            cardTextElement.style.opacity = '0';
            setTimeout(() => {
                const cardType = getRandomCardType();
                if (cardType === 'numberCard') {
                    showNumberCardPrompt();
                } else if (cardType === 'openStoryDriver') {
                    showOpenStoryDriver();
                } else {
                    showGamePrompt(cardType);
                }
                // Start the timer after showing the prompt
                startTimer();
                cardTextElement.style.opacity = '1';
            }, 300);
        }

        function getRandomCardType() {
            const types = ['gameMaster', 'setting', 'character', 'action', 'emotion', 'object', 'dialogue', 'conflict', 'resolution', 'wildcard', 'openStoryDriver', 'numberCard'];
            return types[Math.floor(Math.random() * types.length)];
        }

        function showGamePrompt(category) {
            const prompt = getUniquePrompt(category);
            if (!prompt) {
                cardTextElement.innerHTML = "<b>No more prompts available in this category. Press 'N' for a new game.</b>";
                clearInterval(timerInterval);
                timerBarElement.style.display = 'none';
                return;
            }
            setCardColor(getCategoryColor(category));
            showTypingAnimation(prompt);
        }

        function showNumberCardPrompt() {
            let prompt = getRandomPrompt('numberCard');
            const num = getRandomNumber(1, 6);
            let plural = num === 1 ? '' : 's';
            prompt = prompt.replace('[x]', num).replace('[s]', plural);
            prompt = prompt.replace(/NAME/g, '<u>NAME</u>');
            prompt = prompt.replace(/EMOTION/g, '<u>EMOTION</u>');
            setCardColor('#ADD8E6'); // Light blue color for number cards
            cardTextElement.innerHTML = prompt;
        }

        function showWildcardPrompt() {
            const prompt = getUniquePrompt('wildcard');
            if (!prompt) {
                cardTextElement.innerHTML = "<b>No more wildcards available.</b>";
                return;
            }
            setCardColor('#F5A9A9'); // Desaturated pink-orange color
            showTypingAnimation(prompt);
        }

        function showOpenStoryDriver() {
            const prompt = getRandomPrompt('openStoryDriver');
            setCardColor('#D3D3D3'); // Light grey color for open story drivers
            showTypingAnimation(prompt);
        }

        function getRandomPrompt(category) {
            const categoryPrompts = prompts[category];
            return categoryPrompts[Math.floor(Math.random() * categoryPrompts.length)];
        }

        function getUniquePrompt(category) {
            if (category === 'numberCard' || category === 'openStoryDriver') {
                // Number cards and open story drivers can repeat
                return getRandomPrompt(category);
            }
            const availablePrompts = prompts[category].filter(p => !usedPrompts[category].includes(p));
            if (availablePrompts.length === 0) {
                return null;
            }
            const prompt = availablePrompts[Math.floor(Math.random() * availablePrompts.length)];
            usedPrompts[category].push(prompt);
            return prompt.replace(/NAME/g, '<u>NAME</u>').replace(/EMOTION/g, '<u>EMOTION</u>');
        }

        function setCardColor(color) {
            card.style.backgroundColor = color;
        }

        function getCategoryColor(category) {
            const colors = {
                "gameMaster": "#FFA500", // Orange
                "setting": "#E6E6FA", // Lavender
                "character": "#FFFACD", // Lemon Chiffon
                "action": "#E0FFFF", // Light Cyan
                "emotion": "#F0E68C", // Khaki
                "object": "#D8BFD8", // Thistle
                "dialogue": "#FFE4E1", // Misty Rose
                "conflict": "#FAFAD2", // Light Goldenrod Yellow
                "resolution": "#E6E6FA", // Lavender
                "wildcard": "#F5A9A9", // Desaturated pink-orange
                "openStoryDriver": "#D3D3D3", // Light grey
                "numberCard": "#ADD8E6" // Light blue
            };
            return colors[category] || "#FFFFFF";
        }

        function showTypingAnimation(text) {
            cardTextElement.innerHTML = '';
            let index = 0;
            const speed = 30; // milliseconds per character

            function type() {
                if (index < text.length) {
                    if (text.charAt(index) === '\n') {
                        cardTextElement.innerHTML += '<br>';
                    } else {
                        cardTextElement.innerHTML += text.charAt(index);
                    }
                    index++;
                    setTimeout(type, speed);
                }
            }

            type();
        }

        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function startTimer() {
            let timeLeft = 20; // 20-second timer
            let timerWidth = 100;

            clearInterval(timerInterval); // Clear any previous timer
            timerBarElement.style.width = timerWidth + '%';
            timerBarElement.style.display = 'block';

            timerInterval = setInterval(() => {
                timeLeft--;
                timerWidth -= 5; // Reduce width over 20 seconds
                timerBarElement.style.width = timerWidth + '%';

                if (timeLeft <= 3) {
                    // Flash white towards the end
                    card.style.backgroundColor = timeLeft % 2 === 0 ? 'white' : getCategoryColor(currentCategory);
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerBarElement.style.width = '0%';
                    timerBarElement.style.display = 'none';
                    handleTimerEnd();
                }
            }, 1000);
        }

        let currentCategory = ''; // To keep track of current prompt category

        function handleTimerEnd() {
            tryAgainCount++;
            if (tryAgainCount > 1) {
                // Display reminder to use Wildcards
                cardTextElement.innerHTML = "<b style='color: white;'>Time's up!<br>Take a deep breath and try again.<br>Try pressing 'W' for Wildcards!</b>";
            } else {
                cardTextElement.innerHTML = "<b style='color: white;'>Time's up!<br>Take a deep breath and try again.</b>";
            }
            setCardColor('#777777'); // Medium grey
            // Hide timer bar
            timerBarElement.style.display = 'none';
            // Keep the game in the 'active' state to allow the player to continue
            cardState = 'active';
        }

        // Update category in flipCard function
        function flipCard() {
            // Hide card content briefly to simulate flip
            cardTextElement.style.opacity = '0';
            setTimeout(() => {
                const cardType = getRandomCardType();
                if (cardType === 'numberCard') {
                    currentCategory = 'numberCard';
                    showNumberCardPrompt();
                } else if (cardType === 'openStoryDriver') {
                    currentCategory = 'openStoryDriver';
                    showOpenStoryDriver();
                } else {
                    currentCategory = cardType;
                    showGamePrompt(cardType);
                }
                // Start the timer after showing the prompt
                startTimer();
                cardTextElement.style.opacity = '1';
            }, 300);
        }
    });
</script>

</body>
</html>
