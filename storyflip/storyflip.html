<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      margin: 0;
      background: black;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 80vmin;
      height: 80vmin;
      position: relative;
      cursor: pointer;
      overflow: hidden;
    }

    .mirror-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .quadrant {
      position: absolute;
      top: -0.5%;  /* Slight overlap to prevent lines */
      left: -0.5%;  /* Slight overlap to prevent lines */
      width: 50.5%; /* Slight overlap to ensure seamless edges */
      height: 50.5%; /* Slight overlap to ensure seamless edges */
      mix-blend-mode: screen;
      overflow: hidden; /* Prevent accidental overflow */
    }

    .quadrant-pattern {
      width: 200%; /* Ensures coverage during transformation */
      height: 200%; /* Ensures coverage during transformation */
      position: relative;
    }

    #widget-container {
      position: relative;
      width: 340px;
      height: 500px;
      background: transparent;
      overflow: visible;
    }

    #widget-card, #widget-card-back {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      border-radius: 10px;
      transform: translate(-50%, -50%);
      box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.3);
    }

    #widget-card {
      cursor: pointer;
      transition: background-color 1s ease;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    #card-text {
      font-family: 'EB Garamond', serif;
      font-size: 1.4em;
      color: #333;
      line-height: 1.5;
      font-weight: 400;
      margin: 20px;
      word-wrap: break-word;
      white-space: normal;
    }

    .typing-animation {
      display: inline-block;
      overflow: hidden;
      white-space: normal;
      animation: typing 2s steps(30, end), blink 0.5s step-end infinite alternate;
    }

    #timer-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 5px;
      background-color: rgba(51, 51, 51, 0.5);
      transition: width 1s linear;
      display: none;
    }

    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }

    @keyframes blink {
      from, to { border-right-color: transparent; }
      50% { border-right-color: black; }
    }
  </style>
</head>
<body>

<div id="widget-container">
    <div id="widget-card-back" class="mirror-container"></div>
    <div id="widget-card" class="resting">
        <div id="card-text"></div>
        <div id="timer-bar"></div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const cardBack = document.getElementById("widget-card-back");
        const cardFront = document.getElementById("widget-card");
        const cardTextElement = document.getElementById("card-text");
        const timerBarElement = document.getElementById("timer-bar");

        let cardState = 'resting';
        let timerInterval;

        generatePattern();

        showTitlePage();

        cardFront.addEventListener('click', (event) => {
            event.stopPropagation();
            if (cardState === 'title') {
                showInstructions();
            } else if (cardState === 'instructions') {
                startGame();
            } else if (cardState === 'resting') {
                expandCard();
            } else if (cardState === 'active') {
                flipCard();
            }
        });

        document.addEventListener('click', (e) => {
            if (!cardFront.contains(e.target)) {
                endGame();
            }
        });

        function showTitlePage() {
            cardFront.classList.remove('resting');
            cardFront.classList.add('active');
            cardTextElement.innerHTML = "<b style='font-size: 2em; font-variant: small-caps; font-weight: 700;'>Story</b><br><b style='font-size: 2em; font-weight: 700;'>Flip</b>";
            setCardColor('#FFD700');
            cardFront.style.transform = 'translate(-50%, -50%) scale(0.15)';
            cardState = 'title';
        }

        function showInstructions() {
            cardTextElement.innerHTML = "Welcome to <b style='font-weight: 700;'>Story Flip</b>!<br><br>Click the card to expand and start...";
            setCardColor('#FFE4B5');
            cardState = 'instructions';
        }

        function expandCard() {
            cardFront.classList.remove('resting');
            cardFront.classList.add('active');
            cardState = 'active';
        }

        function startGame() {
            cardState = 'resting';
            expandCard();
        }

        function flipCard() {
            cardFront.style.display = 'none';
            cardBack.style.display = 'flex';

            setTimeout(() => {
                cardBack.style.display = 'none';
                cardFront.style.display = 'flex';

                const cardType = getRandomCardType();
                if (cardType === 'gameMaster') {
                    showGameMasterPrompt();
                } else if (cardType === 'numberCard') {
                    showNumberCardPrompt();
                } else if (cardType === 'stuck') {
                    showStuckPrompt();
                }
            }, 300);

            startTimer();
        }

        function getRandomCardType() {
            const types = ['gameMaster', 'numberCard', 'stuck'];
            return types[Math.floor(Math.random() * types.length)];
        }

        function showGameMasterPrompt() {
            const prompt = getRandomPrompt('gameMaster');
            setCardColor('#FFA500');
            showTypingAnimation(prompt);
        }

        function showNumberCardPrompt() {
            let prompt = getRandomPrompt('numberCard');
            const num = getRandomNumber(1, 6);
            prompt = num === 1 ? prompt.replace('[x] words', '1 word') : prompt.replace('[x]', num);
            setCardColor('#ADD8E6');
            cardTextElement.innerHTML = prompt;
        }

        function showStuckPrompt() {
            const prompt = getRandomPrompt('stuck');
            setCardColor('#A0B0C0');
            showTypingAnimation(prompt);
        }

        function getRandomPrompt(category) {
            const prompts = {
                "gameMaster": [
                    "<b><i>A new character enters the story.</i></b>",
                    "<i>Suddenly...</i>",
                    "The <b>[place]</b> was ... [describe]."
                ],
                "numberCard": [
                    "Add [x] word describing what happens next."
                ],
                "stuck": [
                    "<i>Then, something unexpected happened...</i>"
                ]
            };
            return prompts[category][Math.floor(Math.random() * prompts[category].length)];
        }

        function setCardColor(color) {
            cardFront.style.backgroundColor = color;
        }

        function showTypingAnimation(text) {
            setTimeout(() => {
                cardTextElement.innerHTML = `<span class="typing-animation">${text}</span>`;
            }, 300);
        }

        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function startTimer() {
            let timeLeft = 20;
            let timerWidth = 100;

            clearInterval(timerInterval);
            timerBarElement.style.width = timerWidth + '%';
            timerBarElement.style.display = 'block';

            timerInterval = setInterval(() => {
                timeLeft--;
                timerWidth -= 5;
                timerBarElement.style.width = timerWidth + '%';

                if (timeLeft <= 3) {
                    cardFront.style.backgroundColor = timeLeft % 2 === 0 ? 'white' : '#FFA500';
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerBarElement.style.width = '0%';
                    timerBarElement.style.display = 'none';
                    handleTimerEnd();
                }
            }, 1000);
        }

        function handleTimerEnd() {
            setCardColor('#333333');
            cardTextElement.innerHTML = "<b style='color: white;'>Time's up!<br>Take a deep breath and try again.</b>";
            cardState = 'active';
        }

        function endGame() {
            cardState = 'ended';
            cardFront.classList.remove('active');
            cardFront.classList.add('resting');
            cardFront.style.transform = 'translate(-50%, -50%) scale(0.15)';
            timerBarElement.style.display = 'none';
            cardTextElement.innerHTML = "The game has ended. Press 'N' to start a new story.";
            setCardColor('#f5f5f5');
            timerBarElement.style.width = '0%';

            document.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === 'n') {
                    window.location.reload();
                }
            }, { once: true });
        }

        function generatePattern() {
            const mirrorContainer = document.getElementById('widget-card-back');
            mirrorContainer.innerHTML = '';

            const lineThickness = random(0.5, 1.5);
            const spacing = random(20, 40);
            const angle1 = random(0, 180);
            const angle2 = angle1 + 90;

            const patternStyle = `
                repeating-linear-gradient(
                    ${angle1}deg,
                    transparent,
                    transparent ${lineThickness}px,
                    rgba(255, 255, 255, 1) ${lineThickness}px,
                    rgba(255, 255, 255, 1) ${lineThickness + spacing}px
                ),
                repeating-linear-gradient(
                    ${angle2}deg,
                    transparent,
                    transparent ${lineThickness}px,
                    rgba(255, 255, 255, 0.8) ${lineThickness}px,
                    rgba(255, 255, 255, 0.8) ${lineThickness + spacing}px
                )
            `;

            const positions = [
                { transform: 'translate(0, 0)' },
                { transform: 'translate(100%, 0) scaleX(-1)' },
                { transform: 'translate(0, 100%) scaleY(-1)' },
                { transform: 'translate(100%, 100%) scale(-1, -1)' }
            ];

            positions.forEach((pos) => {
                const quadrant = document.createElement('div');
                quadrant.className = 'quadrant';
                quadrant.style.transform = pos.transform;

                const pattern = document.createElement('div');
                pattern.className = 'quadrant-pattern';
                pattern.style.background = patternStyle;
                pattern.style.backgroundSize = `${spacing * 2}px ${spacing * 2}px`;
                pattern.style.backgroundRepeat = 'repeat';

                quadrant.appendChild(pattern);
                mirrorContainer.appendChild(quadrant);
            });
        }
    });
</script>

</body>
</html>
